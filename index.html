<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Firebase Record Logger â€” Password UI</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAjBbnm8F76BCb9C5fluUyoZ2QnMSXlHOo",
    authDomain: "test-c7bf3.firebaseapp.com",
    databaseURL: "https://test-c7bf3-default-rtdb.firebaseio.com",
    projectId: "test-c7bf3",
    storageBucket: "test-c7bf3.firebasestorage.app",
    messagingSenderId: "573697013702",
    appId: "1:573697013702:web:fe132fc4d796c06bdbe4c7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // On load decide which auth screen to show
  window.onload = async function () {
    try {
      const snap = await get(ref(db, "auth/password"));
      const stored = snap.val();
      if (stored == null) {
        showSection("setPasswordSection");
      } else {
        showSection("loginSection");
      }
    } catch (err) {
      // If DB read fails show login by default (and console the error)
      console.error("Error reading auth/password:", err);
      showSection("loginSection");
    }
  };

  function showSection(id) {
    document.getElementById("setPasswordSection").style.display = (id === "setPasswordSection") ? "block" : "none";
    document.getElementById("loginSection").style.display = (id === "loginSection") ? "block" : "none";
    document.getElementById("appContent").style.display = (id === "appContent") ? "block" : "none";
  }

  // Save plain-text password to database (as requested)
  window.savePassword = async function () {
    const p = document.getElementById("newPassword").value;
    if (!p || p.trim() === "") {
      document.getElementById("setError").innerText = "Password cannot be empty.";
      return;
    }
    try {
      await set(ref(db, "auth/password"), p);
      document.getElementById("setError").innerText = "";
      // Move to login screen
      showSection("loginSection");
      document.getElementById("inputPassword").focus();
      alert("Password saved. Please log in.");
    } catch (err) {
      console.error("Failed saving password:", err);
      document.getElementById("setError").innerText = "Failed to save password (see console).";
    }
  };

  // Log in by comparing to stored plain-text password
  window.login = async function () {
    const entered = document.getElementById("inputPassword").value;
    if (!entered) {
      document.getElementById("loginError").innerText = "Enter password.";
      return;
    }
    try {
      const snap = await get(ref(db, "auth/password"));
      const stored = snap.val();
      if (stored === null) {
        document.getElementById("loginError").innerText = "No password set. Reload page.";
        return;
      }
      if (entered === stored) {
        document.getElementById("loginError").innerText = "";
        showSection("appContent");
      } else {
        document.getElementById("loginError").innerText = "Incorrect password.";
      }
    } catch (err) {
      console.error("Login error:", err);
      document.getElementById("loginError").innerText = "Login failed (see console).";
    }
  };

  // Simple logout: hide app and return to login
  window.lockApp = function () {
    document.getElementById("inputPassword").value = "";
    showSection("loginSection");
  };

  // Application functions (unchanged behavior)
  window.addRecord = async function () {
    const username = document.getElementById("username").value.trim();
    const status = document.getElementById("status").value.trim();
    const elapsed = document.getElementById("elapsed").value.trim();
    const data = document.getElementById("data").value.trim();

    if (!username || !status || !elapsed || !data) {
      alert("Please fill all fields.");
      return;
    }
    try {
      const newRecord = {
        timestamp: new Date().toISOString(),
        username,
        status,
        elapsedTime: elapsed,
        data
      };
      await push(ref(db, "record/"), newRecord);
      alert("Record added successfully.");
      // optional: clear inputs
      document.getElementById("username").value = "";
      document.getElementById("status").value = "";
      document.getElementById("elapsed").value = "";
      document.getElementById("data").value = "";
    } catch (err) {
      console.error("Failed to add record:", err);
      alert("Failed to add record (see console).");
    }
  };

  window.viewRecords = async function () {
    try {
      const snap = await get(ref(db, "record"));
      const records = snap.val();
      const tbody = document.getElementById("recordTableBody");
      tbody.innerHTML = "";
      if (!records) {
        tbody.innerHTML = "<tr><td colspan='5'>No records found.</td></tr>";
        return;
      }
      Object.values(records).forEach(rec => {
        const statusClass = (rec.status == "1") ? "tick" : "cross";
        const row = `<tr>
          <td>${rec.timestamp}</td>
          <td>${rec.username}</td>
          <td style="text-align:center;"><div class="status-circle ${statusClass}"></div></td>
          <td>${rec.elapsedTime}</td>
          <td>${rec.data}</td>
        </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    } catch (err) {
      console.error("Failed to load records:", err);
      alert("Failed to load records (see console).");
    }
  };
</script>

<style>
  :root {
    --bg: #faf6f0;
    --card: #ffffff;
    --accent: #3b5998;
    --accent-hover: #2d4373;
    --muted: #7a7a7a;
  }

  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: var(--bg);
    color: #222;
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 36px 16px;
  }

  h1 { margin: 10px 0 22px; font-size: 20px; text-align: center; }

  /* Card */
  .card {
    width: 360px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(20,20,20,0.08);
    padding: 20px;
    margin: 18px;
  }

  .center {
    text-align: center;
  }

  input[type="password"], input[type="text"] {
    width: 100%;
    box-sizing: border-box;
    padding: 10px 12px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
  }

  .btn {
    display: inline-block;
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    background: var(--accent);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    margin-top: 6px;
  }
  .btn:hover { background: var(--accent-hover); }

  .muted { color: var(--muted); font-size: 13px; margin-top: 8px; }

  .small-row {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
  }

  .link-btn {
    background: transparent;
    color: var(--accent);
    border: none;
    cursor: pointer;
    font-weight: 600;
    padding: 6px;
  }

  /* Table styling for app */
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 12px;
  }
  th, td { border: 1px solid #e3e3e3; padding: 8px; font-size: 13px; text-align: left; }
  th { background: #f3f3f3; font-weight: 700; }

  /* status circle */
  .status-circle { width: 26px; height: 26px; border-radius: 50%; display:inline-block; position:relative; }
  .tick { background: #28a745; }
  .tick::after { content:''; position:absolute; left:50%; top:50%; width:6px; height:12px; border: solid white; border-width: 0 3px 3px 0; transform: translate(-50%,-60%) rotate(45deg); }
  .cross { background: #dc3545; }
  .cross::before, .cross::after { content:''; position:absolute; left:50%; top:50%; width:14px; height:3px; background:white; }
  .cross::before { transform: translate(-50%,-50%) rotate(45deg); }
  .cross::after { transform: translate(-50%,-50%) rotate(-45deg); }

  /* app layout: make the app area wider than card */
  #appWrapper { width: 760px; display: none; gap: 18px; }
  #appContent { display:none; }
  #loginSection, #setPasswordSection { display:none; margin-top: 40px; }

  /* Responsive */
  @media (max-width: 820px) {
    #appWrapper { width: 100%; flex-direction: column; }
    .card { width: 100%; }
  }
</style>
</head>

<body>
  <div style="width:100%; max-width:980px;">
    <h1 class="center">Firebase Record Logger</h1>

    <!-- AUTH area (single column) -->
    <div id="authArea" style="display:flex; justify-content:center;">
      <!-- Set password -->
      <div id="setPasswordSection" class="card">
        <div class="center"><strong>Create a password</strong></div>
        <div style="margin-top:10px;">
          <input id="newPassword" type="password" placeholder="Enter a new password" />
          <div id="setError" class="muted" style="color:#c0392b;"></div>
          <button class="btn" onclick="savePassword()">Save password</button>
          <div class="muted center">Your password will be stored as plain text at <code>auth/password</code>.</div>
        </div>
      </div>

      <!-- Login -->
      <div id="loginSection" class="card">
        <div class="center"><strong>Sign in</strong></div>
        <div style="margin-top:10px;">
          <input id="inputPassword" type="password" placeholder="Password" />
          <div id="loginError" class="muted" style="color:#c0392b;"></div>
          <button class="btn" onclick="login()">Log in</button>
          <div class="muted center">If you haven't set a password yet, you'll be prompted to create one on first load.</div>
        </div>
      </div>
    </div>

    <!-- APP area -->
    <div id="appWrapper" style="display:flex; margin-top:20px;">
      <div id="appContent" style="display:none; width:100%;">
        <div class="card" style="margin-bottom:12px;">
          <div class="small-row">
            <strong>Add Record</strong>
            <div>
              <button class="link-btn" onclick="lockApp()">Lock</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <input id="username" type="text" placeholder="Username" />
            <input id="status" type="text" placeholder="Status (1 = tick)" />
            <input id="elapsed" type="text" placeholder="Elapsed Time" />
            <input id="data" type="text" placeholder="Data" />
            <button class="btn" onclick="addRecord()">Add Record</button>
            <button class="btn" style="background:#555; margin-top:8px;" onclick="viewRecords()">View Records</button>
          </div>
        </div>

        <div class="card">
          <strong>Records</strong>
          <table id="recordTable" aria-live="polite">
            <thead>
              <tr><th>Timestamp</th><th>Username</th><th>Status</th><th>Elapsed</th><th>Data</th></tr>
            </thead>
            <tbody id="recordTableBody">
              <tr><td colspan="5">Click "View Records" to load data.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Reveal app wrapper when user logs in (keeps CSS/JS separation)
    // The module script will call showSection('appContent') which sets display via that function.
    // Here we connect visibility of the wider wrapper to the content.
    const observer = new MutationObserver(() => {
      const appVisible = document.getElementById('appContent').style.display === 'block';
      document.getElementById('appWrapper').style.display = appVisible ? 'flex' : 'none';
    });
    observer.observe(document.getElementById('appContent'), { attributes: true, attributeFilter: ['style'] });
  </script>
</body>
</html>
